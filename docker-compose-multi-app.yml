version: '3.8'

# EC2에서 여러 앱을 동시에 실행하는 설정
# 사용법: docker-compose -f docker-compose-multi-app.yml up -d

services:
  # 당근 부스터 백엔드 (포트 8000)
  karrot-booster:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: karrot-booster
    ports:
      - "8000:8000"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    env_file:
      - .env
    restart: unless-stopped
    mem_limit: 300m        # 메모리 제한 (실제 사용량: ~230MB)
    mem_reservation: 200m   # 최소 예약 메모리
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - app-network

  # 다른 웹 앱 (포트 8001) - 설정 예시
  # 실제 앱으로 교체하세요
  other-app:
    # 다른 앱의 Dockerfile 또는 이미지 지정
    # build:
    #   context: ../other-app-directory
    #   dockerfile: Dockerfile
    # 또는
    # image: your-other-app:latest

    # 임시 예시: Nginx 정적 서버
    image: nginx:alpine
    container_name: other-app
    ports:
      - "8001:80"
    restart: unless-stopped
    mem_limit: 200m
    mem_reservation: 150m
    # volumes:
    #   - ../other-app-directory:/usr/share/nginx/html:ro
    networks:
      - app-network

  # Nginx 리버스 프록시 (선택사항)
  # 포트 번호 없이 깔끔한 URL 사용
  nginx-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-multi-app.conf:/etc/nginx/nginx.conf:ro
      # SSL 인증서 (HTTPS 사용 시)
      # - ./ssl:/etc/nginx/ssl:ro
    restart: unless-stopped
    mem_limit: 100m
    depends_on:
      - karrot-booster
      - other-app
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
