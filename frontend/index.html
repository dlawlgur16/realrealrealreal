<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¹ê·¼ ë¶€ìŠ¤í„° - ì¤‘ê³ ë¬¼í’ˆ í”„ë¦¬ë¯¸ì—„ í¬í†  ì„œë¹„ìŠ¤</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #FAFAFA;
      min-height: 100vh;
    }
    
    /* í—¤ë” */
    .header {
      text-align: center;
      padding: 32px 20px 16px;
      background: white;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .logo-icon {
      font-size: 32px;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: #1A1A1A;
    }
    
    .tagline {
      font-size: 14px;
      color: #6B7280;
    }
    
    /* ë©”ì¸ */
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px 20px;
    }
    
    /* ì—…ë¡œë“œ ì˜ì—­ */
    .upload-area {
      background: white;
      border: 2px dashed #E5E7EB;
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .upload-area:hover,
    .upload-area.dragging {
      border-color: #FF6F0F;
      background: #FFF4ED;
    }
    
    .upload-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      color: #FF6F0F;
    }
    
    .upload-title {
      font-size: 18px;
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 8px;
    }
    
    .upload-subtitle {
      font-size: 14px;
      color: #6B7280;
    }
    
    /* ê¸°ëŠ¥ ì„ íƒ */
    .feature-section {
      display: none;
    }
    
    .feature-section.active {
      display: block;
    }
    
    .preview-container {
      position: relative;
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .preview-image {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .change-btn {
      position: absolute;
      top: 24px;
      right: 24px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #6B7280;
      cursor: pointer;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    
    .feature-card {
      position: relative;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 16px;
      padding: 24px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .feature-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      border-color: #FF6F0F;
    }
    
    .feature-tag {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 11px;
      font-weight: 600;
      color: #FF6F0F;
      background: #FFF4ED;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .feature-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    
    .feature-icon.poster {
      background: rgba(255, 111, 15, 0.1);
      color: #FF6F0F;
    }
    
    .feature-icon.serial {
      background: rgba(34, 197, 94, 0.1);
      color: #22C55E;
    }
    
    .feature-icon.defect {
      background: rgba(245, 158, 11, 0.1);
      color: #F59E0B;
    }
    
    .feature-title {
      font-size: 16px;
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 8px;
    }
    
    .feature-desc {
      font-size: 13px;
      color: #6B7280;
      line-height: 1.5;
    }
    
    /* ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì„¹ì…˜ */
    .reference-section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid #E5E7EB;
    }
    
    .reference-header {
      margin-bottom: 12px;
    }
    
    .reference-title {
      font-size: 16px;
      font-weight: 600;
      color: #1A1A1A;
      margin: 0 0 4px;
    }
    
    .reference-desc {
      font-size: 13px;
      color: #6B7280;
      margin: 0;
    }
    
    .reference-add-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: #F3F4F6;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #1A1A1A;
      cursor: pointer;
      margin-bottom: 12px;
    }
    
    .reference-add-btn:hover {
      background: #E5E7EB;
    }
    
    .reference-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
    }
    
    .reference-item {
      position: relative;
      width: 100%;
      padding-top: 100%;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #E5E7EB;
    }
    
    .reference-thumb {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .reference-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    
    .reference-remove:hover {
      background: rgba(0,0,0,0.8);
    }
    
    /* ì˜ì—­ ì„ íƒ */
    .area-section {
      display: none;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .area-section.active {
      display: block;
    }
    
    .area-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .back-btn {
      padding: 8px 16px;
      background: #F3F4F6;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .area-container {
      position: relative;
      cursor: crosshair;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    
    .area-image {
      width: 100%;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }
    
    .selection-box {
      position: absolute;
      border: 3px solid #FF6F0F;
      background: rgba(255, 111, 15, 0.2);
      border-radius: 4px;
      pointer-events: none;
    }
    
    .area-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }
    
    /* ê²°ê³¼ */
    .result-section {
      display: none;
      background: white;
      border-radius: 16px;
      padding: 32px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .result-section.active {
      display: block;
    }
    
    .result-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .success-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #DCFCE7;
      color: #22C55E;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .compare-container {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .compare-item {
      flex: 1;
      position: relative;
    }
    
    .compare-label {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .compare-label.result {
      background: #FF6F0F;
    }
    
    .compare-image {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #E5E7EB;
    }
    
    .compare-arrow {
      font-size: 24px;
      color: #6B7280;
      flex-shrink: 0;
    }
    
    .result-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .tip-box {
      margin-top: 24px;
      padding: 16px;
      background: #FFF4ED;
      border-radius: 12px;
      font-size: 14px;
      color: #1A1A1A;
      line-height: 1.6;
    }
    
    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btn-primary {
      background: #FF6F0F;
      color: white;
    }
    
    .btn-primary:hover {
      background: #E5630D;
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: white;
      color: #1A1A1A;
      border: 1px solid #E5E7EB;
    }
    
    .btn-secondary:hover {
      background: #F9FAFB;
    }
    
    /* ë¡œë”© */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      background: white;
      border-radius: 20px;
      padding: 40px 60px;
      text-align: center;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #F3F4F6;
      border-top: 4px solid #FF6F0F;
      border-radius: 50%;
      margin: 0 auto 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      font-weight: 600;
      color: #1A1A1A;
      margin-bottom: 8px;
    }
    
    .loading-subtext {
      font-size: 14px;
      color: #6B7280;
    }
    
    /* ì—ëŸ¬ */
    .error-box {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: #FEF2F2;
      border: 1px solid #FECACA;
      border-radius: 12px;
      margin-top: 20px;
      color: #DC2626;
      font-size: 14px;
    }
    
    .error-box.active {
      display: flex;
    }
    
    .error-close {
      margin-left: auto;
      padding: 4px;
      background: none;
      border: none;
      cursor: pointer;
      color: #DC2626;
    }
    
    /* í‘¸í„° */
    .footer {
      text-align: center;
      padding: 24px 20px;
      border-top: 1px solid #E5E7EB;
      background: white;
      margin-top: 40px;
      font-size: 13px;
      color: #6B7280;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 640px) {
      .compare-container {
        flex-direction: column;
      }
      
      .compare-arrow {
        transform: rotate(90deg);
      }
      
      .result-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* ìˆ¨ê¹€ */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header">
    <div class="logo">
      <span class="logo-icon">ğŸ¥•</span>
      <span class="logo-text">ë‹¹ê·¼ ë¶€ìŠ¤í„°</span>
    </div>
    <p class="tagline">ì¤‘ê³ ë¬¼í’ˆì„ í”„ë¦¬ë¯¸ì—„ìœ¼ë¡œ ë³€í™˜í•˜ì„¸ìš”</p>
  </header>

  <!-- ë©”ì¸ -->
  <main class="main">
    <!-- ì—…ë¡œë“œ ì˜ì—­ -->
    <div id="uploadSection" class="upload-area">
      <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
      <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      <h3 class="upload-title">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h3>
      <p class="upload-subtitle">JPG, PNG íŒŒì¼ ì§€ì› â€¢ ìµœëŒ€ 10MB â€¢ ì—¬ëŸ¬ ì´ë¯¸ì§€ ë™ì‹œ ì„ íƒ ê°€ëŠ¥ (ì²« ë²ˆì§¸ê°€ ë©”ì¸, ë‚˜ë¨¸ì§€ëŠ” ë ˆí¼ëŸ°ìŠ¤)</p>
    </div>

    <!-- ê¸°ëŠ¥ ì„ íƒ -->
    <div id="featureSection" class="feature-section">
      <div class="preview-container">
        <img id="previewImage" class="preview-image" src="" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€">
        <button class="change-btn" onclick="resetToUpload()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
          </svg>
          ë‹¤ë¥¸ ì´ë¯¸ì§€
        </button>
      </div>
      
      <!-- ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì„¹ì…˜ -->
      <div class="reference-section">
        <div class="reference-header">
          <h4 class="reference-title">ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)</h4>
          <p class="reference-desc">ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì˜ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ë©´ ë” ì¼ê´€ëœ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ í•œ ë²ˆì— ì„ íƒí•˜ê±°ë‚˜ ì—¬ëŸ¬ ë²ˆ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <input
          id="referenceInput"
          type="file"
          accept="image/*"
          multiple
          style="display: none;"
          onchange="handleReferenceSelect(event)"
        />
        <button class="reference-add-btn" onclick="document.getElementById('referenceInput').click()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì¶”ê°€
        </button>
        <div id="referenceGrid" class="reference-grid"></div>
      </div>
      
      <div class="feature-grid">
        <div class="feature-card" onclick="selectFeature('poster')">
          <span class="feature-tag">ê°€ì¥ ì¸ê¸°</span>
          <div class="feature-icon poster">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 3l1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3z"/>
            </svg>
          </div>
          <h4 class="feature-title">í¬ìŠ¤í„°í˜• ì¸ë„¤ì¼</h4>
          <p class="feature-desc">ìŠ¤íŠœë””ì˜¤ê¸‰ ë°°ê²½ê³¼ ì¡°ëª…ìœ¼ë¡œ ë³€í™˜</p>
        </div>
        
        <div class="feature-card" onclick="selectFeature('serial')">
          <span class="feature-tag">ì‹ ë¢°ë„ UP</span>
          <div class="feature-icon serial">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
          <h4 class="feature-title">ì¸ì¦ ì˜ì—­ ì„ ëª…í™”</h4>
          <p class="feature-desc">ì‹œë¦¬ì–¼ ë„˜ë²„, ëª¨ë¸ëª… ë“± ê°•ì¡°</p>
        </div>
        
        <div class="feature-card" onclick="selectFeature('defect')">
          <span class="feature-tag">ì •ì§í•¨</span>
          <div class="feature-icon defect">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
          </div>
          <h4 class="feature-title">í•˜ì ë¶€ë¶„ ê°•ì¡°</h4>
          <p class="feature-desc">ì •ì§í•œ ìƒíƒœ í‘œì‹œë¡œ ì‹ ë¢° í™•ë³´</p>
        </div>
      </div>
    </div>

    <!-- ì˜ì—­ ì„ íƒ -->
    <div id="areaSection" class="area-section">
      <div class="area-header">
        <button class="back-btn" onclick="backToFeature()">â† ë’¤ë¡œ</button>
        <h3 id="areaTitle">ì˜ì—­ì„ ë“œë˜ê·¸ë¡œ ì„ íƒí•˜ì„¸ìš”</h3>
      </div>
      
      <div id="areaContainer" class="area-container">
        <img id="areaImage" class="area-image" src="" alt="ì˜ì—­ ì„ íƒ">
        <div id="selectionBox" class="selection-box" style="display: none;"></div>
      </div>
      
      <div class="area-actions">
        <button class="btn btn-secondary" onclick="clearSelection()">ì´ˆê¸°í™”</button>
        <button id="processBtn" class="btn btn-primary" onclick="processWithArea()" disabled>
          ì´ ì˜ì—­ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸°
        </button>
      </div>
    </div>

    <!-- ê²°ê³¼ -->
    <div id="resultSection" class="result-section">
      <div class="result-header">
        <span class="success-badge">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          ì™„ë£Œ
        </span>
        <h3 id="resultTitle">ì²˜ë¦¬ ì™„ë£Œ!</h3>
      </div>
      
      <div class="compare-container">
        <div class="compare-item">
          <span class="compare-label">ì›ë³¸</span>
          <img id="originalImage" class="compare-image" src="" alt="ì›ë³¸">
        </div>
        <div class="compare-arrow">â†’</div>
        <div class="compare-item">
          <span class="compare-label result">ê²°ê³¼</span>
          <img id="resultImage" class="compare-image" src="" alt="ê²°ê³¼">
        </div>
      </div>
      
      <div class="result-actions">
        <button class="btn btn-secondary" onclick="resetToUpload()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
          </svg>
          ìƒˆë¡œìš´ ì´ë¯¸ì§€
        </button>
        <button class="btn btn-primary" onclick="downloadResult()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
      
      <div class="tip-box">
        <strong>ğŸ’¡ íŒë§¤ íŒ:</strong> ì´ ì´ë¯¸ì§€ë¥¼ ì²« ë²ˆì§¸ ì‚¬ì§„ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ì‹¤ì œ ì œí’ˆ ì‚¬ì§„ì„ ì˜¬ë ¤ ì‹ ë¢°ë„ë¥¼ ë†’ì´ì„¸ìš”!
      </div>
    </div>

    <!-- ì—ëŸ¬ -->
    <div id="errorBox" class="error-box">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <span id="errorMessage"></span>
      <button class="error-close" onclick="hideError()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
  </main>

  <!-- ë¡œë”© -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p class="loading-text">AIê°€ ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
      <p class="loading-subtext">ì•½ 10~30ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤</p>
    </div>
  </div>

  <!-- í‘¸í„° -->
  <footer class="footer">
    <p>Powered by Gemini 3 Pro Image â€¢ Made for ë‹¹ê·¼ë§ˆì¼“ íŒë§¤ì</p>
  </footer>

  <script>
    // API ì„¤ì •
    const API_BASE_URL = 'http://localhost:8000';
    
    // ìƒíƒœ
    let selectedFile = null;
    let selectedFileUrl = null;
    let currentProcessType = null;
    let selectionArea = null;
    let isSelecting = false;
    let startPos = null;
    let referenceFiles = [];
    
    // DOM ìš”ì†Œ
    const uploadSection = document.getElementById('uploadSection');
    const featureSection = document.getElementById('featureSection');
    const areaSection = document.getElementById('areaSection');
    const resultSection = document.getElementById('resultSection');
    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');
    const areaImage = document.getElementById('areaImage');
    const areaContainer = document.getElementById('areaContainer');
    const selectionBox = document.getElementById('selectionBox');
    const processBtn = document.getElementById('processBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const errorBox = document.getElementById('errorBox');
    const errorMessage = document.getElementById('errorMessage');
    
    // ì—…ë¡œë“œ ì´ë²¤íŠ¸
    uploadSection.addEventListener('click', () => fileInput.click());
    uploadSection.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadSection.classList.add('dragging');
    });
    uploadSection.addEventListener('dragleave', () => {
      uploadSection.classList.remove('dragging');
    });
    uploadSection.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadSection.classList.remove('dragging');
      const files = Array.from(e.dataTransfer.files || []);
      const imageFiles = files.filter(file => file.type.startsWith('image/'));
      if (imageFiles.length > 0) {
        handleFileSelect(imageFiles);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      if (files.length > 0) handleFileSelect(files);
    });
    
    // íŒŒì¼ ì„ íƒ ì²˜ë¦¬ (ì—¬ëŸ¬ íŒŒì¼ ì§€ì›)
    function handleFileSelect(files) {
      const imageFiles = files.filter(file => file.type.startsWith('image/'));
      if (imageFiles.length === 0) return;
      
      // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ë©”ì¸ìœ¼ë¡œ
      selectedFile = imageFiles[0];
      selectedFileUrl = URL.createObjectURL(imageFiles[0]);
      previewImage.src = selectedFileUrl;
      areaImage.src = selectedFileUrl;
      
      // ë‚˜ë¨¸ì§€ ì´ë¯¸ì§€ë¥¼ ë ˆí¼ëŸ°ìŠ¤ë¡œ
      referenceFiles = imageFiles.slice(1);
      updateReferenceGrid();
      
      showSection('feature');
      hideError();
    }
    
    // ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬
    function handleReferenceSelect(event) {
      const files = Array.from(event.target.files || []);
      const imageFiles = files.filter(file => file.type.startsWith('image/'));
      if (imageFiles.length > 0) {
        referenceFiles = [...referenceFiles, ...imageFiles];
        updateReferenceGrid();
        // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ input ì´ˆê¸°í™”
        event.target.value = '';
      }
    }
    
    // ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
    function updateReferenceGrid() {
      const grid = document.getElementById('referenceGrid');
      grid.innerHTML = '';
      
      referenceFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'reference-item';
        item.innerHTML = `
          <img src="${URL.createObjectURL(file)}" alt="ë ˆí¼ëŸ°ìŠ¤ ${index + 1}" class="reference-thumb">
          <button class="reference-remove" onclick="removeReference(${index})">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        `;
        grid.appendChild(item);
      });
    }
    
    // ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì œê±°
    function removeReference(index) {
      referenceFiles = referenceFiles.filter((_, i) => i !== index);
      updateReferenceGrid();
    }
    
    // ì„¹ì…˜ ì „í™˜
    function showSection(section) {
      uploadSection.classList.add('hidden');
      featureSection.classList.remove('active');
      areaSection.classList.remove('active');
      resultSection.classList.remove('active');
      
      switch(section) {
        case 'upload':
          uploadSection.classList.remove('hidden');
          break;
        case 'feature':
          featureSection.classList.add('active');
          break;
        case 'area':
          areaSection.classList.add('active');
          break;
        case 'result':
          resultSection.classList.add('active');
          break;
      }
    }
    
    // ê¸°ëŠ¥ ì„ íƒ
    function selectFeature(type) {
      currentProcessType = type;
      
      if (type === 'poster') {
        processImage();
      } else {
        const titles = {
          serial: 'ì‹œë¦¬ì–¼ ë„˜ë²„/ì¸ì¦ ì˜ì—­ì„ ë“œë˜ê·¸ë¡œ ì„ íƒí•˜ì„¸ìš”',
          defect: 'í•˜ì ë¶€ë¶„ì„ ë“œë˜ê·¸ë¡œ ì„ íƒí•˜ì„¸ìš”'
        };
        document.getElementById('areaTitle').textContent = titles[type];
        clearSelection();
        showSection('area');
      }
    }
    
    // ì˜ì—­ ì„ íƒ ì´ë²¤íŠ¸
    areaContainer.addEventListener('mousedown', (e) => {
      const rect = areaImage.getBoundingClientRect();
      startPos = {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
      isSelecting = true;
      selectionBox.style.display = 'block';
    });
    
    areaContainer.addEventListener('mousemove', (e) => {
      if (!isSelecting || !startPos) return;
      
      const rect = areaImage.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      selectionArea = {
        x: Math.min(startPos.x, x),
        y: Math.min(startPos.y, y),
        width: Math.abs(x - startPos.x),
        height: Math.abs(y - startPos.y)
      };
      
      selectionBox.style.left = selectionArea.x + 'px';
      selectionBox.style.top = selectionArea.y + 'px';
      selectionBox.style.width = selectionArea.width + 'px';
      selectionBox.style.height = selectionArea.height + 'px';
      
      processBtn.disabled = selectionArea.width < 10 || selectionArea.height < 10;
    });
    
    areaContainer.addEventListener('mouseup', () => {
      isSelecting = false;
    });
    
    areaContainer.addEventListener('mouseleave', () => {
      isSelecting = false;
    });
    
    // ì„ íƒ ì´ˆê¸°í™”
    function clearSelection() {
      selectionArea = null;
      selectionBox.style.display = 'none';
      processBtn.disabled = true;
    }
    
    // ì˜ì—­ ì„ íƒ í›„ ì²˜ë¦¬
    function processWithArea() {
      if (!selectionArea || selectionArea.width < 10) return;
      
      // ì‹¤ì œ ì´ë¯¸ì§€ í¬ê¸° ëŒ€ë¹„ ë¹„ìœ¨ ê³„ì‚°
      const scaleX = areaImage.naturalWidth / areaImage.clientWidth;
      const scaleY = areaImage.naturalHeight / areaImage.clientHeight;
      
      const scaledArea = {
        x: selectionArea.x * scaleX,
        y: selectionArea.y * scaleY,
        width: selectionArea.width * scaleX,
        height: selectionArea.height * scaleY
      };
      
      processImage(scaledArea);
    }
    
    // ì´ë¯¸ì§€ ì²˜ë¦¬ API í˜¸ì¶œ
    async function processImage(area = null) {
      if (!selectedFile) return;
      
      showLoading(true);
      hideError();
      
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('process_type', currentProcessType);
      
      // ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì¶”ê°€
      if (referenceFiles.length > 0) {
        referenceFiles.forEach((refFile) => {
          formData.append('reference_files', refFile);
        });
      }
      
      if (area) {
        formData.append('mask_x', Math.round(area.x));
        formData.append('mask_y', Math.round(area.y));
        formData.append('mask_width', Math.round(area.width));
        formData.append('mask_height', Math.round(area.height));
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/process`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success && result.image_base64) {
          showResult(result.image_base64);
        } else {
          showError(result.message || 'ì´ë¯¸ì§€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        showLoading(false);
      }
    }
    
    // ê²°ê³¼ í‘œì‹œ
    function showResult(base64) {
      const typeLabels = {
        poster: 'í¬ìŠ¤í„°í˜• ì¸ë„¤ì¼',
        serial: 'ì¸ì¦ ì˜ì—­ ì„ ëª…í™”',
        defect: 'í•˜ì ë¶€ë¶„ ê°•ì¡°'
      };
      
      document.getElementById('resultTitle').textContent = typeLabels[currentProcessType] + ' ì²˜ë¦¬ ì™„ë£Œ!';
      document.getElementById('originalImage').src = selectedFileUrl;
      document.getElementById('resultImage').src = `data:image/png;base64,${base64}`;
      
      showSection('result');
    }
    
    // ë‹¤ìš´ë¡œë“œ
    function downloadResult() {
      const resultImg = document.getElementById('resultImage');
      const link = document.createElement('a');
      link.href = resultImg.src;
      link.download = `karrot-booster-${currentProcessType}-${Date.now()}.png`;
      link.click();
    }
    
    // ì´ˆê¸°í™”
    function resetToUpload() {
      selectedFile = null;
      selectedFileUrl = null;
      currentProcessType = null;
      selectionArea = null;
      referenceFiles = [];
      fileInput.value = '';
      document.getElementById('referenceInput').value = '';
      updateReferenceGrid();
      clearSelection();
      showSection('upload');
      hideError();
    }
    
    // ê¸°ëŠ¥ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
    function backToFeature() {
      clearSelection();
      showSection('feature');
    }
    
    // ë¡œë”©
    function showLoading(show) {
      loadingOverlay.classList.toggle('active', show);
    }
    
    // ì—ëŸ¬
    function showError(message) {
      errorMessage.textContent = message;
      errorBox.classList.add('active');
    }
    
    function hideError() {
      errorBox.classList.remove('active');
    }
  </script>
</body>
</html>
